<div class="risk-container p-4">
  <h3 class="form-title mb-4">Operational Risk Assessment Form</h3>

  <!-- Back Button -->
  <div class="top-right-button mb-3" *ngIf="showForm || updateForm || showCaptureList || showCaptureListActionPlan || showChart">
    <button class="btn btn-outline-secondary" (click)="goBack()">
      <span class="material-icons">arrow_back</span> Back
    </button>
  </div>

  <!-- Initial Actions -->
  <div *ngIf="!showForm && !updateForm && !showCaptureList && !showCaptureListActionPlan && !showChart" class="button-container text-center mb-4">
    <h2>Select an Action</h2>
    <button class="btn btn-primary m-2" *ngIf="currentUser?.role !== 'User'" (click)="startNewRisk()">Capture/Update Operational Risk Register</button>
    <button class="btn btn-info m-2" (click)="updateProgress()">Update Operational Risk Action Plan Progress</button>
    <button class="btn btn-success m-2" (click)="generateReport()">Generate and View Report</button>
  </div>

  <!-- Captured Risks Table -->
  <div *ngIf="showCaptureList && !showForm" class="mb-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2>Captured Operational Risks</h2>
      <div class="d-flex gap-2">
        <input type="text" [(ngModel)]="searchTerm" (ngModelChange)="applyFilter()" placeholder="Search by Objective or Owner" class="form-control">
        <button class="btn btn-primary" (click)="startNewRisk()">‚ûï Capture New Risk</button>
      </div>
    </div>

    <mat-table [dataSource]="dataSource" class="mat-elevation-z8 mb-3">
      <ng-container matColumnDef="riskNumber">
        <mat-header-cell *matHeaderCellDef>Risk Number</mat-header-cell>
        <mat-cell *matCellDef="let risk">{{ risk.riskNumber }}</mat-cell>
      </ng-container>
      <ng-container matColumnDef="operationalObjective">
        <mat-header-cell *matHeaderCellDef>Operational Objective</mat-header-cell>
        <mat-cell *matCellDef="let risk">{{ risk.operationalObjective }}</mat-cell>
      </ng-container>
      <ng-container matColumnDef="riskDescription">
        <mat-header-cell *matHeaderCellDef>Risk Description</mat-header-cell>
        <mat-cell *matCellDef="let risk">{{ risk.riskDescription }}</mat-cell>
      </ng-container>
      <ng-container matColumnDef="riskOwner">
        <mat-header-cell *matHeaderCellDef>Risk Owner</mat-header-cell>
        <mat-cell *matCellDef="let risk">{{ risk.riskOwner }}</mat-cell>
      </ng-container>
      <ng-container matColumnDef="capturedDate">
        <mat-header-cell *matHeaderCellDef>Captured Date</mat-header-cell>
        <mat-cell *matCellDef="let risk">{{ risk.capturedDate | date:'shortDate' }}</mat-cell>
      </ng-container>
      <ng-container matColumnDef="actions">
        <mat-header-cell *matHeaderCellDef>Actions</mat-header-cell>
        <mat-cell *matCellDef="let risk">
          <button mat-button color="primary" (click)="editRisk(risk)">‚úèÔ∏è Update Risk</button>
          <button mat-button color="warn" (click)="deleteRisk(risk.id)">üóëÔ∏è Delete</button>
        </mat-cell>
      </ng-container>

      <mat-header-row *matHeaderRowDef="displayedColumns"></mat-header-row>
      <mat-row *matRowDef="let row; columns: displayedColumns;"></mat-row>
    </mat-table>

    <mat-paginator [pageSize]="5" [pageSizeOptions]="[5,10,20]" showFirstLastButtons></mat-paginator>
  </div>

  <!-- Action Plan Progress Table -->
  <div *ngIf="showCaptureListActionPlan && !updateForm" class="mb-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2>Update Action Plan</h2>
      <input type="text" [(ngModel)]="searchTerm" (ngModelChange)="applyFilter()" placeholder="Search by Objective or Owner" class="form-control w-50">
    </div>

    <mat-table [dataSource]="dataSource1" class="mat-elevation-z8 mb-3">
      <ng-container matColumnDef="riskNumber">
        <mat-header-cell *matHeaderCellDef>Risk Number</mat-header-cell>
        <mat-cell *matCellDef="let risk">{{ risk.riskNumber }}</mat-cell>
      </ng-container>
      <ng-container matColumnDef="operationalObjective">
        <mat-header-cell *matHeaderCellDef>Operational Objective</mat-header-cell>
        <mat-cell *matCellDef="let risk">{{ risk.operationalObjective }}</mat-cell>
      </ng-container>
      <ng-container matColumnDef="status">
        <mat-header-cell *matHeaderCellDef>Status</mat-header-cell>
        <mat-cell *matCellDef="let risk">{{ risk.planStatus }}</mat-cell>
      </ng-container>
      <ng-container matColumnDef="capturedDate">
        <mat-header-cell *matHeaderCellDef>Captured Date</mat-header-cell>
        <mat-cell *matCellDef="let risk">{{ risk.capturedDate | date:'shortDate' }}</mat-cell>
      </ng-container>
      <ng-container matColumnDef="actions">
        <mat-header-cell *matHeaderCellDef>Actions</mat-header-cell>
        <mat-cell *matCellDef="let risk">
          <button mat-button color="accent" (click)="editProgress(risk)">‚úèÔ∏è Edit Progress</button>
        </mat-cell>
      </ng-container>

      <mat-header-row *matHeaderRowDef="displayedColumns1"></mat-header-row>
      <mat-row *matRowDef="let row; columns: displayedColumns1;"></mat-row>
    </mat-table>

    <mat-paginator [pageSize]="5" [pageSizeOptions]="[5,10,20]" showFirstLastButtons></mat-paginator>
  </div>

  <!-- Operational Risk Form -->
  <form [formGroup]="riskForm" *ngIf="showForm">
    <!-- General Info Section -->
    <div class="section mb-4">
      <h4>General Information</h4>
      <div class="row g-3">
        <div class="col-md-6">
          <label>Operational Objective</label>
          <input type="text" class="form-control" formControlName="operationalObjective">
        </div>
        <div class="col-md-6">
          <label>Operational Risk Description</label>
          <input type="text" class="form-control" formControlName="riskDescription">
        </div>
        <div class="col-md-6">
          <label>Root Causes</label>
          <input type="text" class="form-control" formControlName="rootCauses">
        </div>
        <div class="col-md-6">
          <label>Consequences</label>
          <input type="text" class="form-control" formControlName="consequences">
        </div>
      </div>
    </div>

    <!-- Inherent Risk Rating -->
    <div class="section mb-4">
      <h4>Inherent Risk Rating</h4>
      <div class="row g-3">
        <div class="col-md-4">
          <label>Probability/Likelihood</label>
          <select class="form-select" formControlName="inherentProbability">
            <option *ngFor="let num of [1,2,3,4,5]" [value]="num">{{ num }}</option>
          </select>
        </div>
        <div class="col-md-4">
          <label>Impact/Consequence</label>
          <select class="form-select" formControlName="inherentImpact">
            <option *ngFor="let num of [1,2,3,4,5]" [value]="num">{{ num }}</option>
          </select>
        </div>
        <div class="col-md-4">
          <label>Overall Inherent Risk</label>
          <input type="text" class="form-control" formControlName="overallInherentRisk" readonly>
        </div>
      </div>
    </div>

    <!-- Control Measures Section -->
    <div class="section mb-4">
      <h4>Control Measures</h4>
      <div class="row g-3">
        <div class="col-md-6">
          <label>Existing Controls</label>
          <input type="text" class="form-control" formControlName="existingControls">
        </div>
        <div class="col-md-6">
          <label>Type of Control</label>
          <select class="form-select" formControlName="typeOfControl">
            <option value="Preventive">Preventive</option>
            <option value="Detective">Detective</option>
            <option value="Corrective">Corrective</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Residual Risk Section -->
    <div class="section mb-4">
      <h4>Residual Risk Rating</h4>
      <div class="row g-3">
        <div class="col-md-3">
          <label>Probability/Likelihood</label>
          <select class="form-select" formControlName="residualProbability">
            <option *ngFor="let num of [1,2,3,4,5]" [value]="num">{{ num }}</option>
          </select>
        </div>
        <div class="col-md-3">
          <label>Impact/Consequence</label>
          <select class="form-select" formControlName="residualImpact">
            <option *ngFor="let num of [1,2,3,4,5]" [value]="num">{{ num }}</option>
          </select>
        </div>
        <div class="col-md-3">
          <label>Overall Residual Risk</label>
          <input type="text" class="form-control" formControlName="overallResidualRisk" readonly>
        </div>
        <div class="col-md-3">
          <label>Risk Status</label>
          <input type="text" class="form-control" formControlName="riskStatus" readonly>
        </div>
      </div>
    </div>

    <!-- Mitigation Section -->
    <div class="section mb-4">
      <h4>Mitigation & Responsibility</h4>
      <div class="row g-3">
        <div class="col-md-6">
          <label>Mitigating/Action Plan</label>
          <input type="text" class="form-control" formControlName="mitigatingPlan">
        </div>
        <div class="col-md-6">
          <label>Risk Owner</label>
          <select class="form-select" formControlName="riskOwner">
            <option value="Manager A">Manager A</option>
            <option value="Manager B">Manager B</option>
          </select>
        </div>
        <div class="col-md-6">
          <label>Mitigating Plan Responsible Person</label>
          <select class="form-select" formControlName="responsiblePerson">
            <option value="Person X">Person X</option>
            <option value="Person Y">Person Y</option>
          </select>
        </div>
        <div class="col-md-6">
          <label>Completion Date</label>
          <input type="date" class="form-control" formControlName="completionDate">
        </div>
      </div>
    </div>

    <!-- Action Plan Table -->
    <div class="section mb-4 p-3 bg-light border" *ngIf="actionPlans.length">
      <h4>Action Plan</h4>
      <mat-table [dataSource]="actionPlans">
        <ng-container matColumnDef="action">
          <mat-header-cell *matHeaderCellDef>Action</mat-header-cell>
          <mat-cell *matCellDef="let plan">{{ plan.action }}</mat-cell>
        </ng-container>
        <ng-container matColumnDef="dueDate">
          <mat-header-cell *matHeaderCellDef>Due Date</mat-header-cell>
          <mat-cell *matCellDef="let plan">{{ plan.dueDate | date:'shortDate' }}</mat-cell>
        </ng-container>
        <ng-container matColumnDef="progress">
          <mat-header-cell *matHeaderCellDef>Progress</mat-header-cell>
          <mat-cell *matCellDef="let plan">{{ plan.progress }}</mat-cell>
        </ng-container>
        <mat-header-row *matHeaderRowDef="['action','dueDate','progress']"></mat-header-row>
        <mat-row *matRowDef="let row; columns: ['action','dueDate','progress']"></mat-row>
      </mat-table>
    </div>

    <!-- Chart Section -->
    <div class="section mb-4" *ngIf="showChart">
      <h4>Operational Risk Analysis Chart</h4>
      <canvas baseChart
              [data]="chartData"
              [options]="chartOptions"
              [legend]="true"
              [type]="selectedChartType">
      </canvas>
    </div>

    <!-- Form Buttons -->
    <div class="button-container d-flex gap-2">
      <button type="submit" class="btn btn-success" [disabled]="!riskForm.valid" (click)="submitRiskForm()">Submit</button>
      <button type="button" class="btn btn-primary" [disabled]="riskForm.invalid" (click)="generateReport()">Generate Report</button>
    </div>
  </form>
</div>
